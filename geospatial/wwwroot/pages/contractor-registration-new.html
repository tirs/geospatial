<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Contractor - Urban Referral Network</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/urban-theme.css">
    <script src="../js/zip-autocomplete.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
        }

        .top-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 2rem;
        }

        .logo-text h1 {
            font-size: 1.25rem;
            margin: 0;
        }

        .logo-text p {
            font-size: 0.875rem;
            opacity: 0.9;
            margin: 0;
        }

        .contact-info {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .registration-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 32px;
            text-align: center;
        }

        .header-banner h1 {
            font-size: 2.5rem;
            margin-bottom: 16px;
        }

        .call-center-notice {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            color: #1e40af;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: #6b7280;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: background 0.2s;
            margin: 16px 0;
        }

        .back-button:hover {
            background: #4b5563;
        }

        .form-container {
            padding: 32px;
        }

        .form-section {
            margin-bottom: 32px;
            padding: 24px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: #fafbfc;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .required {
            color: #ef4444;
        }

        .form-input, .form-select, .form-textarea {
            padding: 12px 16px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .field-hint {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 4px;
        }

        .service-types {
            margin-top: 16px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 32px auto;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .notification {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        .success-actions {
            margin-top: 12px;
            display: flex;
            gap: 12px;
        }

        .dashboard-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #10b981;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
        }

        .tip-box {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            padding: 16px;
            color: #166534;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 16px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header-banner h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">üè¢</div>
            <div class="logo-text">
                <h1>Urban Referral Network</h1>
                <p>Call Center Registration Portal</p>
            </div>
        </div>
        <div class="contact-info">
            <span>üìû 1-800-777-7777</span>
        </div>
    </div>

    <div class="main-container">
        <div class="registration-container">
            <div class="header-banner">
                <h1>‚ûï Add New Contractor</h1>
                <div class="call-center-notice">
                    <strong>üìû Call Center Registration:</strong> Use this form to manually register contractors who visit the call center in person.
                </div>
                <a href="call-center.html" class="back-button">
                    ‚Üê Back to Call Center
                </a>
            </div>

            <div class="form-container">
                <div class="notification success-message" id="successMessage">
                    ‚úÖ Contractor registered successfully! They can now receive referrals through the system.
                    <div class="success-actions">
                        <a href="call-center.html" class="dashboard-link">‚Üê Back to Call Center</a>
                        <a href="contractor-registration-new.html" class="dashboard-link">‚ûï Add Another Contractor</a>
                    </div>
                </div>
                
                <div class="notification error-message" id="errorMessage">
                    ‚ùå Registration failed. Please check your information and try again.
                </div>
                
                <div class="tip-box">
                    <strong>üí° Tip:</strong> Fill out all required fields carefully. The contractor will receive login credentials via email after registration.
                </div>

                <form id="contractorForm">
                    <!-- Company Information -->
                    <div class="form-section">
                        <h3 class="section-title">üè¢ Company Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="companyName">Company Name <span class="required">*</span></label>
                                <input type="text" id="companyName" name="companyName" class="form-input" placeholder="Company Name LLC" required>
                                <small class="field-hint">Company name must include business entity type (LLC, Inc, etc.)</small>
                            </div>
                            <div class="form-group">
                                <label for="contactName">Contact Person <span class="required">*</span></label>
                                <input type="text" id="contactName" name="contactName" class="form-input" placeholder="Primary contact name" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="phone">Phone Number <span class="required">*</span></label>
                                <input type="tel" id="phone" name="phone" class="form-input" placeholder="(XXX) XXX-XXXX" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Email Address <span class="required">*</span></label>
                                <input type="email" id="email" name="email" class="form-input" placeholder="contact@company.com" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="username">Username <span class="required">*</span></label>
                                <input type="text" id="username" name="username" class="form-input" placeholder="Choose a unique username" required>
                                <small class="field-hint">This will be used to login to the contractor dashboard</small>
                            </div>
                            <div class="form-group">
                                <label for="password">Password <span class="required">*</span></label>
                                <input type="password" id="password" name="password" class="form-input" placeholder="Create a secure password" required>
                                <small class="field-hint">Minimum 8 characters</small>
                            </div>
                        </div>
                    </div>

                    <!-- Location Information -->
                    <div class="form-section">
                        <h3 class="section-title">üìç Location & Service Area</h3>
                        <div class="form-group">
                            <label for="address">Business Address <span class="required">*</span></label>
                            <input type="text" id="address" name="address" class="form-input" placeholder="Street address" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="city">City <span class="required">*</span></label>
                                <input type="text" id="city" name="city" class="form-input" placeholder="City" required>
                            </div>
                            <div class="form-group">
                                <label for="state">State <span class="required">*</span></label>
                                <select id="state" name="state" class="form-select" required>
                                    <option value="">Select State</option>
                                    <option value="CA">California</option>
                                    <option value="NV">Nevada</option>
                                    <option value="AZ">Arizona</option>
                                    <option value="OR">Oregon</option>
                                    <option value="WA">Washington</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="zipCode">ZIP Code <span class="required">*</span></label>
                                <input type="text" id="zipCode" name="zipCode" class="form-input zip-autocomplete" placeholder="Enter ZIP code" maxlength="5" required>
                            </div>
                            <div class="form-group">
                                <label for="serviceRadius">Service Radius (miles) <span class="required">*</span></label>
                                <select id="serviceRadius" name="serviceRadius" class="form-select" required>
                                    <option value="">Select radius</option>
                                    <option value="10">10 miles</option>
                                    <option value="15">15 miles</option>
                                    <option value="20">20 miles</option>
                                    <option value="25">25 miles</option>
                                    <option value="30">30 miles</option>
                                    <option value="35">35 miles</option>
                                    <option value="40">40 miles</option>
                                    <option value="50">50 miles</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Services Offered -->
                    <div class="form-section">
                        <h3 class="section-title">üîß Services Offered</h3>
                        <p class="service-description">Select all services this contractor provides. Use "Select All" for general contractors.</p>
                        <div class="service-types" id="serviceTypes">
                            <!-- Services will be loaded dynamically -->
                        </div>
                    </div>

                    <!-- License & Certification -->
                    <div class="form-section">
                        <h3 class="section-title">üìú License & Certification</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="license">California Contractors License Number <span class="required">*</span></label>
                                <input type="text" id="license" name="license" class="form-input" placeholder="e.g., 123456" required>
                                <small class="field-hint">Valid California Contractors State License Board (CSLB) license required</small>
                            </div>
                            <div class="form-group">
                                <label for="licenseClass">License Classification <span class="required">*</span></label>
                                <select id="licenseClass" name="licenseClass" class="form-select" required>
                                    <option value="">Select Classification</option>
                                    <option value="A">A - General Engineering</option>
                                    <option value="B">B - General Building</option>
                                    <option value="C-10">C-10 - Electrical</option>
                                    <option value="C-15">C-15 - Flooring and Floor Covering</option>
                                    <option value="C-20">C-20 - Warm-Air Heating, Ventilating and Air-Conditioning</option>
                                    <option value="C-27">C-27 - Landscaping</option>
                                    <option value="C-33">C-33 - Painting and Decorating</option>
                                    <option value="C-36">C-36 - Plumbing</option>
                                    <option value="C-39">C-39 - Roofing</option>
                                    <option value="C-46">C-46 - Solar</option>
                                    <option value="C-53">C-53 - Swimming Pool</option>
                                    <option value="C-54">C-54 - Ceramic and Mosaic Tile</option>
                                    <option value="Other">Other Classification</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="licenseExpiry">License Expiry Date <span class="required">*</span></label>
                                <input type="date" id="licenseExpiry" name="licenseExpiry" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="bondAmount">Bond Amount <span class="required">*</span></label>
                                <select id="bondAmount" name="bondAmount" class="form-select" required>
                                    <option value="">Select Bond Amount</option>
                                    <option value="15000">$15,000</option>
                                    <option value="25000">$25,000</option>
                                    <option value="50000">$50,000</option>
                                    <option value="100000">$100,000</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Insurance & Experience -->
                    <div class="form-section">
                        <h3 class="section-title">üõ°Ô∏è Insurance & Experience</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="experience">Years of Experience <span class="required">*</span></label>
                                <select id="experience" name="experience" class="form-select" required>
                                    <option value="">Select experience</option>
                                    <option value="1-2">1-2 years</option>
                                    <option value="3-5">3-5 years</option>
                                    <option value="6-10">6-10 years</option>
                                    <option value="11-15">11-15 years</option>
                                    <option value="16+">16+ years</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="insuranceCarrier">Insurance Carrier <span class="required">*</span></label>
                                <input type="text" id="insuranceCarrier" name="insuranceCarrier" class="form-input" placeholder="Insurance company name" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="insuranceAmount">General Liability Coverage <span class="required">*</span></label>
                                <select id="insuranceAmount" name="insuranceAmount" class="form-select" required>
                                    <option value="">Select Coverage Amount</option>
                                    <option value="500000">$500,000</option>
                                    <option value="1000000">$1,000,000</option>
                                    <option value="2000000">$2,000,000</option>
                                    <option value="5000000">$5,000,000</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="insuranceExpiry">Insurance Expiry Date <span class="required">*</span></label>
                                <input type="date" id="insuranceExpiry" name="insuranceExpiry" class="form-input" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="insurancePolicy">Policy Number</label>
                            <input type="text" id="insurancePolicy" name="insurancePolicy" class="form-input" placeholder="Insurance policy number">
                        </div>
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn">
                        <span>‚úÖ</span> Register Contractor
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        class ContractorRegistration {
            constructor() {
                this.apiBase = '/api';
                this.init();
            }

            async init() {
                await this.loadServiceTypes();
                this.setupEventListeners();
            }

            async loadServiceTypes() {
                try {
                    const serviceCategories = {
                        'Essential Services': [
                            'üîß Plumbing', '‚ö° Electrical', 'üå°Ô∏è HVAC', 'üè† Roofing'
                        ],
                        'Construction & Repair': [
                            'üî® General Contracting', 'ü™ö Carpentry', 'üß± Drywall', 'üèóÔ∏è Concrete Work'
                        ],
                        'Flooring & Surfaces': [
                            'üè† Flooring Installation', 'üé® Tile Work', 'üñºÔ∏è Painting & Decorating'
                        ],
                        'Outdoor & Landscaping': [
                            'üåø Landscaping', 'üöß Fencing', 'üèä Pool Services', 'üå≥ Tree Services'
                        ],
                        'Specialized Services': [
                            'üç≥ Kitchen Remodeling', 'üõÅ Bathroom Remodeling', 'üî• Fireplace Services', '‚òÄÔ∏è Solar Installation'
                        ]
                    };

                    const container = document.getElementById('serviceTypes');
                    container.innerHTML = '';
                    
                    // Add "Select All" option
                    const selectAllDiv = document.createElement('div');
                    selectAllDiv.innerHTML = `
                        <div style="background: #f3f4f6; border: 2px solid #d1d5db; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                            <label style="display: flex; align-items: center; gap: 12px; font-weight: 600; color: #374151; cursor: pointer; font-size: 1.1rem;">
                                <input type="checkbox" id="selectAllServices" style="transform: scale(1.3);">
                                <span>‚úÖ Select All Services (Quick Option for General Contractors)</span>
                            </label>
                        </div>
                    `;
                    container.appendChild(selectAllDiv);

                    // Add categories
                    Object.entries(serviceCategories).forEach(([category, services]) => {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.innerHTML = `
                            <h4 style="color: #1f2937; font-size: 1.2rem; font-weight: 600; margin: 24px 0 16px 0; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">
                                ${category}
                            </h4>
                        `;
                        
                        const servicesGrid = document.createElement('div');
                        servicesGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 24px;';
                        
                        services.forEach(service => {
                            const serviceValue = service.replace(/[üîß‚ö°üå°Ô∏èüè†üî®ü™öüß±üèóÔ∏èüé®üñºÔ∏èüåøüößüèäüå≥üç≥üõÅüî•‚òÄÔ∏è]\s/, '');
                            const div = document.createElement('div');
                            div.style.cssText = 'background: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 14px; transition: all 0.2s; cursor: pointer;';
                            div.innerHTML = `
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; font-weight: 500; font-size: 1rem;">
                                    <input type="checkbox" name="services" value="${serviceValue}" style="transform: scale(1.3);">
                                    <span>${service}</span>
                                </label>
                            `;
                            
                            // Add interactive effects
                            div.addEventListener('mouseenter', () => {
                                div.style.borderColor = '#3b82f6';
                                div.style.backgroundColor = '#f8fafc';
                            });
                            
                            div.addEventListener('mouseleave', () => {
                                const checkbox = div.querySelector('input[type="checkbox"]');
                                if (!checkbox.checked) {
                                    div.style.borderColor = '#e5e7eb';
                                    div.style.backgroundColor = 'white';
                                }
                            });
                            
                            div.addEventListener('click', (e) => {
                                if (e.target.type !== 'checkbox') {
                                    const checkbox = div.querySelector('input[type="checkbox"]');
                                    checkbox.checked = !checkbox.checked;
                                    checkbox.dispatchEvent(new Event('change'));
                                }
                            });
                            
                            const checkbox = div.querySelector('input[type="checkbox"]');
                            checkbox.addEventListener('change', () => {
                                if (checkbox.checked) {
                                    div.style.borderColor = '#10b981';
                                    div.style.backgroundColor = '#f0fdf4';
                                } else {
                                    div.style.borderColor = '#e5e7eb';
                                    div.style.backgroundColor = 'white';
                                }
                            });
                            
                            servicesGrid.appendChild(div);
                        });
                        
                        categoryDiv.appendChild(servicesGrid);
                        container.appendChild(categoryDiv);
                    });

                    // Setup "Select All" functionality
                    const selectAllCheckbox = document.getElementById('selectAllServices');
                    selectAllCheckbox.addEventListener('change', () => {
                        const allServiceCheckboxes = container.querySelectorAll('input[name="services"]');
                        allServiceCheckboxes.forEach(checkbox => {
                            checkbox.checked = selectAllCheckbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        });
                    });

                } catch (error) {
                    console.error('Error loading service types:', error);
                }
            }

            setupEventListeners() {
                document.getElementById('contractorForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSubmit(e);
                });
            }

            async handleSubmit(e) {
                const form = e.target;
                const formData = new FormData(form);
                const submitBtn = document.getElementById('submitBtn');
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span>‚è≥</span> Registering...';

                try {
                    // Get selected services
                    const selectedServices = Array.from(document.querySelectorAll('input[name="services"]:checked'))
                        .map(checkbox => checkbox.value);

                    if (selectedServices.length === 0) {
                        this.showError('Please select at least one service type.');
                        return;
                    }

                    // Prepare contractor data
                    const contractorData = {
                        id: Date.now(),
                        companyName: formData.get('companyName'),
                        contactName: formData.get('contactName'),
                        phone: formData.get('phone'),
                        email: formData.get('email'),
                        username: formData.get('username'),
                        password: formData.get('password'),
                        address: formData.get('address'),
                        city: formData.get('city'),
                        state: formData.get('state'),
                        zipCode: formData.get('zipCode'),
                        serviceRadius: formData.get('serviceRadius'),
                        services: selectedServices,
                        license: formData.get('license'),
                        licenseClass: formData.get('licenseClass'),
                        licenseExpiry: formData.get('licenseExpiry'),
                        bondAmount: formData.get('bondAmount'),
                        experience: formData.get('experience'),
                        insuranceCarrier: formData.get('insuranceCarrier'),
                        insuranceAmount: formData.get('insuranceAmount'),
                        insuranceExpiry: formData.get('insuranceExpiry'),
                        insurancePolicy: formData.get('insurancePolicy'),
                        registrationDate: new Date().toISOString(),
                        status: 'active', // Call center registrations are pre-approved
                        registeredBy: 'Call Center Agent'
                    };

                    // Save via API instead of localStorage
                    await this.saveToAPI(contractorData);
                    this.showSuccess();
                    form.reset();

                } catch (error) {
                    console.error('Registration error:', error);
                    this.showError('Registration failed. Please try again.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<span>‚úÖ</span> Register Contractor';
                }
            }

            async saveToAPI(contractorData) {
                try {
                    const response = await fetch('/api/Contractors', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(contractorData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Contractor registered via API:', result);
                    } else {
                        console.log('‚ö†Ô∏è API not available - contractor registered locally');
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è API not available - contractor registered locally');
                }
            }

            showSuccess() {
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = `‚ùå ${message}`;
                errorDiv.style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ContractorRegistration();
        });
    </script>
</body>
</html>