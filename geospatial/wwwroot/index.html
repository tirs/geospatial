<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="msapplication-navbutton-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Urban Referral Network - Management Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/urban-theme.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo-section">
                <div class="logo-icon">üè¢</div>
                <div class="logo-text">
                    <h1>Urban Referral Network</h1>
                    <p>Management Portal</p>
                </div>
            </div>
            <div class="header-contact">
                <span class="phone">üìû 1-800-777-7777</span>
                <div class="user-menu">
                    <span class="user-name">Loading...</span>
                    <button class="logout-btn" title="Logout">üö™</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="hero-section">
            <div class="hero-content">
                <h2>Call Center Referral Management System</h2>
                <p class="hero-subtitle">Manage the complete 10-step referral process from customer call to job completion</p>
                
                <div class="quick-actions">
                    <a href="pages/call-center.html" class="action-card primary">
                        <div class="action-icon"></div>
                        <div class="action-content">
                            <h3>Call Center</h3>
                            <p>Handle customer calls and create referrals</p>
                        </div>
                    </a>
                    
                    <a href="pages/contractor-finder.html" class="action-card">
                        <div class="action-icon">üîç</div>
                        <div class="action-content">
                            <h3>Find Contractors</h3>
                            <p>Search and select 3 service providers</p>
                        </div>
                    </a>
                    
                    <a href="pages/dashboard.html" class="action-card">
                        <div class="action-icon"></div>
                        <div class="action-content">
                            <h3>Dashboard</h3>
                            <p>Track referral status and analytics</p>
                        </div>
                    </a>
                    
                    <a href="pages/training-center.html" class="action-card">
                        <div class="action-icon">üéì</div>
                        <div class="action-content">
                            <h3>Training</h3>
                            <p>Learn the 10-step referral process</p>
                        </div>
                    </a>
                    
                    <a href="pages/contractor-registration-new.html" class="action-card">
                        <div class="action-icon">üèóÔ∏è</div>
                        <div class="action-content">
                            <h3>Join as Contractor</h3>
                            <p>Register to receive customer referrals</p>
                        </div>
                    </a>
                    
                    <a href="pages/database-query.html" class="action-card admin-only">
                        <div class="action-icon">üóÑÔ∏è</div>
                        <div class="action-content">
                            <h3>Database Query</h3>
                            <p>Explore and query system data</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- How It Works Section -->
        <section class="process-section">
            <div class="process-container">
                <h2>How Our Referral Process Works</h2>
                <p class="process-subtitle">Follow these 10 steps to complete every customer referral</p>
                
                <div class="process-steps">
                    <div class="step-card">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3>Customer Calls</h3>
                            <p>Customer calls and requests service through our call center representative</p>
                        </div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3>Refer 3 Providers</h3>
                            <p>Call center representative refers three (3) service providers</p>
                        </div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3>Providers Notified</h3>
                            <p>Service providers receive customer's request(s) for service</p>
                        </div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h3>Schedule Appointments</h3>
                            <p>Service providers call and schedule appointments with customer</p>
                        </div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">5</div>
                        <div class="step-content">
                            <h3>Home Visits</h3>
                            <p>Each provider visits customer's home and provides estimate</p>
                        </div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">6</div>
                        <div class="step-content">
                            <h3>Customer Decision</h3>
                            <p>Customer makes decision from estimates and informs URN</p>
                        </div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">7</div>
                        <div class="step-content">
                            <h3>Enter Selection</h3>
                            <p>Call center representative enters selection into URN database</p>
                        </div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">8</div>
                        <div class="step-content">
                            <h3>Schedule Work</h3>
                            <p>Work is scheduled by customer with selected service provider</p>
                        </div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">9</div>
                        <div class="step-content">
                            <h3>Work Begins</h3>
                            <p>Service provider begins work according to schedule</p>
                        </div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">10</div>
                        <div class="step-content">
                            <h3>Follow Up</h3>
                            <p>Monitor job completion and customer satisfaction</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Access Notice -->
        <section class="access-notice">
            <div class="notice-content">
                <div class="notice-icon">üîí</div>
                <h3>Authorized Personnel Only</h3>
                <p>This system is accessible only to trained URN call center representatives and authorized staff members who understand the complete referral process.</p>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 Urban Referral Network. Created to protect the consumer.</p>
            <p>Serving Los Angeles County with quality contractors since 2016</p>
        </div>
    </footer>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check authentication on page load
        window.addEventListener('load', async () => {
            const sessionToken = localStorage.getItem('sessionToken');
            if (sessionToken) {
                // User is logged in, validate session and redirect
                try {
                    const response = await fetch('/api/Auth/validate', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${sessionToken}`
                        }
                    });
                    const result = await response.json();
                    if (result.result === 'VALID') {
                        // Redirect based on role
                        const userRole = localStorage.getItem('userRole');
                        switch (userRole) {
                            case 'Admin':
                            case 'Manager':
                                window.location.href = '/pages/dashboard.html';
                                break;
                            default:
                                window.location.href = '/pages/call-center.html';
                        }
                        return;
                    }
                } catch (error) {
                    // Invalid session, clear and continue to login redirect
                    localStorage.clear();
                }
            }
            
            // No valid session, redirect to login after a short delay to show the page
            setTimeout(() => {
                window.location.href = '/login.html';
            }, 2000);
        });

        // Simple click tracking for analytics
        document.querySelectorAll('.action-card').forEach(card => {
            card.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent navigation since we'll redirect to login
                const cardName = this.querySelector('h3').textContent;
                console.log(`Navigating to: ${cardName}`);
                window.location.href = '/login.html';
            });
        });

        // Accessibility: Handle keyboard navigation
        document.querySelectorAll('.action-card').forEach(card => {
            card.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
    </script>

    <!-- Authentication -->
    <script src="js/auth.js"></script>
    <script>
        // Clear demo data on production startup
        function clearDemoData() {
            // Remove demo contractor data
            localStorage.removeItem('pendingContractors');
            localStorage.removeItem('contractors');
            localStorage.removeItem('rejectedContractors');
            localStorage.removeItem('contractorsProcessed');
        }

        // Initialize authentication
        document.addEventListener('DOMContentLoaded', async function() {
            // Clear demo data first
            clearDemoData();
            
            // Check if user is authenticated
            const isAuthenticated = await auth.validateSession();
            
            if (isAuthenticated) {
                // User is logged in, update UI
                auth.updateUserDisplay();
                auth.addLogoutHandlers();
                
                // Remove the redirect behavior for authenticated users
                document.querySelectorAll('.action-card').forEach(card => {
                    const newCard = card.cloneNode(true);
                    card.parentNode.replaceChild(newCard, card);
                    
                    // Add normal navigation for authenticated users
                    newCard.addEventListener('click', function(e) {
                        const href = this.getAttribute('href');
                        if (href) {
                            window.location.href = href;
                        }
                    });
                });
            } else {
                // User not authenticated, redirect to unified login
                window.location.href = '/unified-login.html';
            }
        });
    </script>
</body>
</html>